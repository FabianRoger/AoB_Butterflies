---
title: "ÄoB analysis of Butterflydata"
author: "Fabian Roger"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  github_document:
    toc: yes
    toc_depth: 5
    pandoc_args: --webtex
  html_document:
    keep_md: yes
    theme: readable
    mathjax: default
  pdf_document:
    toc: yes
---

load packages

```{r}
library(here)
library(dplyr)
library(tidyr)
library(ggplot2)
library(readxl)
```

load data and clean data

Data description:

+ Länstyrelsen data (county counts other than SLU)

--> biotop only for Länstyrelsen
--> Slingor and Transects, analyse separately unless they have length so we can standardise

+ SLU data (collected by SLU, location needs to be checked from spatial information)

+ from 2009 to 2018 (doublecheck)
There is differnt periods 9-13 and 14-18, Analyse seperately?

vadd_tist_klint only SLU

Spatial data in sheet 'site_geo'

EPSG:3021

--> get county info from county shapefile and geo-location of routes

```{r}
RMO <- read_excel("RMO_combined_data.xlsx", sheet = "all_observations_clean_no_calc", 
                  col_types = "text")

Var_RMO <- read_excel("RMO_combined_data.xlsx", sheet = 1)

Var_RMO %>% 
  filter(Variable %in% colnames(RMO)) %>% 
  View()

#checking those numeric variables that will be analysed

#count OK
as.numeric(RMO$count) %>% is.na %>% sum

#segment --> need fixing if necessary (mixed numeric 1,2,.. and text S1, S2, ..)
RMO[which(is.na(as.numeric(RMO$segment))),"segment"] %>% table()

#S1-17 --> strip "S"
#S --> 1
#A-K --> 1-11
# drop rest

#biotope --> need fixing. Includes comments ("se anm") and uncertain numeric code ("13/11"). But rel few cases in total (632)
RMO$biotope[!is.na(RMO$biotope)][which(is.na(as.numeric(RMO$biotope[!is.na(RMO$biotope)])))] %>% table() 

#remove all funky habitats
# check if NAs for Slingor (SiteType == "S) can be imputed

#length --> mostly OK. Numeric or missing value. Some text (only 11 cases)
RMO$length[!is.na(RMO$length)][which(is.na(as.numeric(RMO$length[!is.na(RMO$length)])))]

# c <- 246
# i.u. <-  ? 
# check if length can be imputed from other years
# for "transect" we have all shape files, for "slingor" not for all

#perc_veg_0-5 --> needs fixing. Includes comments, symbols ("x") and unrecognized NAs (that are coded as "NA" in raw data)
RMO$`perc_veg_0-5`[!is.na(RMO$`perc_veg_0-5`)][which(is.na(as.numeric(RMO$`perc_veg_0-5`[!is.na(RMO$`perc_veg_0-5`)])))] %>% 
  table() 

#perc_veg_5-15 --> needs fixing. Includes comments, symbols ("x") and unrecognized NAs (that are coded as "NA" in raw data)
RMO$`perc_veg_5-15`[!is.na(RMO$`perc_veg_5-15`)][which(is.na(as.numeric(RMO$`perc_veg_5-15`[!is.na(RMO$`perc_veg_5-15`)])))] %>% table() 

#perc_veg_above_15 --> needs fixing. Includes comments, symbols ("x") and unrecognized NAs (that are coded as "NA" in raw data)
RMO$`perc_veg_above_15`[!is.na(RMO$`perc_veg_above_15`)][which(is.na(as.numeric(RMO$`perc_veg_above_15`[!is.na(RMO$`perc_veg_above_15`)])))] %>% table() 

# should only be present in transects and should ideally sum to 100% between three size classes
# NAs might be 0 if other categories sum to 100
# x's are likely 100 if no x in other categories

#per_mill_flowers --> needs fixing. Includes wrongly formatted numbers, comments and literal "NA" (as text)
RMO$per_mill_flowers[!is.na(RMO$per_mill_flowers)][which(is.na(as.numeric(RMO$per_mill_flowers[!is.na(RMO$per_mill_flowers)])))] %>% table() 

#,0,05 -> 5%?
# <X -> truncate to X
# mean of range

#perc_vadd_tist_klint --> needs fixing. Includes wrongly formated NAs and comments
RMO$perc_vadd_tist_klint[!is.na(RMO$perc_vadd_tist_klint)][which(is.na(as.numeric(RMO$perc_vadd_tist_klint[!is.na(RMO$perc_vadd_tist_klint)])))] %>% table() 

#exclude

#vadd_tist_klint OK
RMO$vadd_tist_klint %>% unique()

#temp OK
is.numeric(RMO$temp[!is.na(RMO$temp)]) %>% is.na %>% sum

### more variables to be anaylsed ### ???

# HavdStatus
RMO$HavdStatus[!is.na(RMO$HavdStatus) & !grepl("NA", RMO$HavdStatus)] %>% table

# HavdNotkreatur

# HavdFar

# HavdHast

```

To produce the code for the figures I start by just excluding all non-numeric variables.

!!! NEED TO FIX LATER !!!!

```{r}
RMO <- 
  RMO %>% 
  select("site code", "county", "SpeciesText", 
         "Species ID", "count", "biotope", "length", 
         "perc_veg_0-5", "perc_veg_5-15", "perc_veg_above_15",
         "per_mill_flowers", "perc_vadd_tist_klint", "vadd_tist_klint",
         "temp")

RMO <- RMO %>% 
  mutate(across(.cols= c("count", "biotope", "length", 
         "perc_veg_0-5", "perc_veg_5-15", "perc_veg_above_15",
         "per_mill_flowers", "perc_vadd_tist_klint", "vadd_tist_klint",
         "temp"), as.numeric))

RMO <- RMO %>% 
  mutate(county = case_when(
    county == "M" ~ "Skåne",
    county == "H" ~ "Kalmar",
    county == "F" ~ "Jörnköping",
    county == "E" ~ "Östergötland",
    county == "T" ~ "Örebro",
    county == "SLU" ~ NA_character_,
    TRUE ~ county
  ))

RMO <- RMO %>% 
  mutate(biotope = case_when(
    biotope == 1 ~ "Skogsbryn",
    biotope == 2 ~ "Vägren",
    biotope == 3 ~ "Dikesren",
    biotope == 4 ~ "Hygge",
    biotope == 5 ~ "Kärr",
    biotope == 6 ~ "Mosse",
    biotope == 7 ~ "Vall",
    biotope == 8 ~ "Trädgårdar",
    biotope == 9 ~ "Hällmark",
    biotope == 10 ~ "Sandmark",
    biotope == 11 ~ "Kraftledning",
    biotope == 12 ~ "Skogsbryn",
    biotope == 13 ~ "Skogsbryn",
    biotope == 14 ~ "Skogsbryn",
    biotope == 15 ~ "Skogsbryn",
    biotope == 16 ~ "Skogsbryn",
    TRUE ~ county
  ))




RMO %>% filter(county == "SLU")


```


# Figures

check Analysfrågar svar final for how to analyse

## Artrikedom per inventerat objekt

total species richness and richness of grassland specialist (map)

separately between slingor and transects --> check methods previous report 
seperatly between periods 

## Antal individer /art/år

vertical barplot of total number of individuals by species (for all species) 

Q: which year? (Are there several?)

## Enkel jämförelse – antal arter i transekter och slingor 

(obs bara regionala data). Uppdelat transekter och slingor för att kunna jmf de två perioderna?

Histogram of number of species / location, divided between "slingor" and "transektor"

## Biotoptypernas medel artantal + jmf perioderna

Mean N species + CI by biotoptyp

## Biotoptypernas artantal och relativa mängd

Total number of species observed by biotoptyp, coloured sep if redlisted, compared to total area of that biotoptyp

--> double axis chart, needs different visualization

## Samband mängd nektarkällor och för artantal och individantal

species abundance vs nectar abundance
richness vs nectar abundance

(now barplot but prob. better scatterplot)

## Samband vegetationshöjd och  artantal och individantal

same for vegetation height

## Typiska arter för resp biotop (slingssegmenten)

(should we do some multivar anlaysis here to see what species are sign more abundant in certain biotop type?)

## Trend analysis 

Is this dealt with?

## Jmf av artsammansättning mellan länen och de ingående objekten

NMDS (or here CCA) of species composition between 6 län

same for 'lab' (what is lab)

## Jmf artsammansättningen för de olika biotoptyperna (sling segmenten)

same as above for different biotop types

## Vilka parametrar (nektarrikedom, veghöjd…) viktiga för olika arterna?

what env var are important for different species. Vegan correspondance analysis. 

Q: What env variables do we want to include here?

## Potentialen att hysa gräsmarksfjärilsspecialister

--> check R code Spatial for this and some more spatial analysis









